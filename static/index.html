<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>APIPod Gateway - 账号池管理</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f1117;--bg2:#1a1d28;--bg3:#242736;--bg4:#2d3143;
  --text:#e4e7ec;--text2:#9ca3b0;--text3:#6b7280;
  --blue:#3b82f6;--blue2:#2563eb;--green:#22c55e;--green2:#16a34a;
  --red:#ef4444;--red2:#dc2626;--yellow:#eab308;--orange:#f97316;
  --purple:#a855f7;--cyan:#06b6d4;
  --border:#2d3143;--shadow:0 4px 24px rgba(0,0,0,.3);
  --radius:10px;
}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;min-height:100vh}
a{color:var(--blue);text-decoration:none}

/* Layout */
.app{display:flex;min-height:100vh}
.sidebar{width:240px;background:var(--bg2);border-right:1px solid var(--border);padding:20px 0;flex-shrink:0;position:fixed;height:100vh;overflow-y:auto}
.main{flex:1;margin-left:240px;padding:24px 32px}

/* Sidebar */
.logo{padding:0 20px 24px;border-bottom:1px solid var(--border);margin-bottom:16px}
.logo h1{font-size:18px;font-weight:700;color:var(--text)}
.logo span{font-size:12px;color:var(--text3);display:block;margin-top:2px}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 20px;color:var(--text2);cursor:pointer;transition:.15s;font-size:14px}
.nav-item:hover{background:var(--bg3);color:var(--text)}
.nav-item.active{background:var(--bg3);color:var(--blue);border-right:3px solid var(--blue)}
.nav-item svg{width:18px;height:18px;flex-shrink:0}
.nav-section{padding:16px 20px 8px;font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:var(--text3)}

/* Header */
.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
.page-header h2{font-size:22px;font-weight:600}

/* Cards */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:20px;transition:.2s}
.stat-card:hover{border-color:var(--blue);transform:translateY(-1px)}
.stat-label{font-size:12px;color:var(--text3);text-transform:uppercase;letter-spacing:.03em;margin-bottom:8px}
.stat-value{font-size:28px;font-weight:700}
.stat-value.green{color:var(--green)}
.stat-value.red{color:var(--red)}
.stat-value.blue{color:var(--blue)}
.stat-value.yellow{color:var(--yellow)}
.stat-sub{font-size:12px;color:var(--text3);margin-top:4px}

/* Panels */
.panel{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:24px;overflow:hidden}
.panel-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--border)}
.panel-title{font-size:15px;font-weight:600}
.panel-body{padding:20px}
.panel-body.no-pad{padding:0}

/* Table */
table{width:100%;border-collapse:collapse}
th{text-align:left;padding:10px 16px;font-size:12px;color:var(--text3);text-transform:uppercase;letter-spacing:.03em;background:var(--bg3);font-weight:500}
td{padding:12px 16px;border-bottom:1px solid var(--border);font-size:13px}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(59,130,246,.04)}
.td-email{font-family:monospace;font-size:12px;color:var(--cyan)}
.td-key{font-family:monospace;font-size:11px;color:var(--text3);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* Badges */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}
.badge-active{background:rgba(34,197,94,.12);color:var(--green)}
.badge-inactive{background:rgba(107,114,128,.12);color:var(--text3)}
.badge-error{background:rgba(239,68,68,.12);color:var(--red)}
.badge-rate_limited{background:rgba(234,179,8,.12);color:var(--yellow)}
.badge-banned{background:rgba(239,68,68,.12);color:var(--red)}
.badge::before{content:'';width:6px;height:6px;border-radius:50%;background:currentColor}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border:none;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;transition:.15s}
.btn-primary{background:var(--blue);color:#fff}
.btn-primary:hover{background:var(--blue2)}
.btn-success{background:var(--green);color:#fff}
.btn-success:hover{background:var(--green2)}
.btn-danger{background:var(--red);color:#fff}
.btn-danger:hover{background:var(--red2)}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border)}
.btn-ghost:hover{background:var(--bg3);color:var(--text)}
.btn-sm{padding:5px 10px;font-size:12px}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-group{display:flex;gap:6px}

/* Forms */
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:13px;color:var(--text2);margin-bottom:6px}
.form-input{width:100%;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;outline:none;transition:.15s}
.form-input:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(59,130,246,.15)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:1000;display:none;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:12px;width:520px;max-width:90vw;max-height:85vh;overflow-y:auto;box-shadow:var(--shadow)}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid var(--border)}
.modal-header h3{font-size:16px;font-weight:600}
.modal-close{width:28px;height:28px;display:flex;align-items:center;justify-content:center;border:none;background:transparent;color:var(--text3);cursor:pointer;border-radius:6px;font-size:18px}
.modal-close:hover{background:var(--bg3);color:var(--text)}
.modal-body{padding:24px}
.modal-footer{display:flex;justify-content:flex-end;gap:8px;padding:16px 24px;border-top:1px solid var(--border)}

/* Logs */
.log-item{display:flex;align-items:center;gap:12px;padding:10px 16px;border-bottom:1px solid var(--border);font-size:12px}
.log-item:last-child{border-bottom:none}
.log-time{color:var(--text3);font-family:monospace;flex-shrink:0;width:75px}
.log-method{color:var(--purple);font-family:monospace;flex-shrink:0;width:180px}
.log-account{color:var(--cyan);font-family:monospace;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.log-status{flex-shrink:0;width:50px;text-align:center}
.log-time-val{color:var(--text3);flex-shrink:0;width:60px;text-align:right}

/* Gateway info */
.gateway-box{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px}
.gateway-box code{display:block;font-family:monospace;font-size:13px;color:var(--cyan);padding:8px 12px;background:var(--bg2);border-radius:6px;margin-top:8px;user-select:all}
.gateway-box .label{font-size:12px;color:var(--text3)}

/* Toast */
.toast{position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:8px;font-size:13px;z-index:2000;animation:slideIn .3s;box-shadow:var(--shadow)}
.toast-success{background:var(--green);color:#fff}
.toast-error{background:var(--red);color:#fff}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

/* Loading */
.loading{display:flex;align-items:center;justify-content:center;padding:40px;color:var(--text3)}
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .6s linear infinite;margin-right:10px}
@keyframes spin{to{transform:rotate(360deg)}}

/* Empty */
.empty{text-align:center;padding:48px 20px;color:var(--text3)}
.empty svg{width:48px;height:48px;margin-bottom:12px;opacity:.3}
.empty p{font-size:14px}

/* Page sections */
.page{display:none}
.page.active{display:block}

/* Code blocks */
.code-block{background:var(--bg);padding:16px;border-radius:8px;font-size:13px;overflow-x:auto;font-family:'Fira Code',Consolas,Monaco,monospace;line-height:1.8;margin:0;white-space:pre}
.code-comment{color:#6a9955}
.code-keyword{color:#c586c0}
.code-string{color:#ce9178}
.code-number{color:#b5cea8}
.code-tab{transition:.2s}

/* Responsive */
@media(max-width:768px){
  .sidebar{display:none}
  .main{margin-left:0}
  .stats-grid{grid-template-columns:repeat(2,1fr)}
  .form-row{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div class="app">
  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="logo">
      <h1>APIPod Gateway</h1>
      <span>Account Pool Manager</span>
    </div>
    <div class="user-info" id="user-info" style="padding:12px 20px;border-bottom:1px solid var(--border);margin-bottom:16px;display:none">
      <div style="display:flex;align-items:center;gap:10px">
        <div style="width:32px;height:32px;border-radius:50%;background:var(--blue);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:14px" id="user-avatar">A</div>
        <div style="flex:1">
          <div style="font-size:13px;font-weight:500" id="user-name">Admin</div>
          <div style="font-size:11px;color:var(--text3)" id="user-role">Administrator</div>
        </div>
        <button class="btn btn-ghost btn-sm" onclick="logout()" title="Logout" style="padding:6px">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        </button>
      </div>
    </div>
    <div class="nav-section">Overview</div>
    <div class="nav-item active" data-page="dashboard">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Dashboard
    </div>
    <div class="nav-item" data-page="accounts">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      Accounts
    </div>
    <div class="nav-section">Gateway</div>
    <div class="nav-item" data-page="gateway">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
      API Gateway
    </div>
    <div class="nav-item" data-page="apikeys">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
      API Keys
    </div>
    <div class="nav-item" data-page="logs">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
      Logs
    </div>
    <div class="nav-section">Tools</div>
    <div class="nav-item" data-page="register">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
      Register
    </div>
  </nav>

  <!-- Main Content -->
  <div class="main">

    <!-- Dashboard Page -->
    <div class="page active" id="page-dashboard">
      <div class="page-header">
        <h2>Dashboard</h2>
        <div class="btn-group">
          <button class="btn btn-ghost btn-sm" onclick="refreshDashboard()">Refresh</button>
          <button class="btn btn-primary btn-sm" onclick="healthCheckAll()">Health Check All</button>
        </div>
      </div>

      <div class="stats-grid" id="stats-grid">
        <div class="stat-card"><div class="stat-label">Total Accounts</div><div class="stat-value blue" id="stat-total">-</div></div>
        <div class="stat-card"><div class="stat-label">Active</div><div class="stat-value green" id="stat-active">-</div></div>
        <div class="stat-card"><div class="stat-label">Error / Cooling</div><div class="stat-value red" id="stat-error">-</div></div>
        <div class="stat-card"><div class="stat-label">Total Requests</div><div class="stat-value" id="stat-requests">-</div></div>
        <div class="stat-card"><div class="stat-label">Success Rate</div><div class="stat-value green" id="stat-success-rate">-</div></div>
        <div class="stat-card"><div class="stat-label">Avg Response</div><div class="stat-value" id="stat-avg-time">-</div></div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">Recent Requests</span>
        </div>
        <div class="panel-body no-pad" id="recent-logs">
          <div class="loading"><div class="spinner"></div>Loading...</div>
        </div>
      </div>
    </div>

    <!-- Accounts Page -->
    <div class="page" id="page-accounts">
      <div class="page-header">
        <h2>Account Management</h2>
        <div class="btn-group">
          <button class="btn btn-ghost btn-sm" onclick="loadAccounts()">Refresh</button>
          <button class="btn btn-primary btn-sm" onclick="showModal('add-modal')">Add Account</button>
          <button class="btn btn-success btn-sm" onclick="showModal('import-modal')">Import JSON</button>
        </div>
      </div>

      <div class="panel">
        <div class="panel-body no-pad">
          <table>
            <thead>
              <tr>
                <th>Email</th>
                <th>Username</th>
                <th>Status</th>
                <th>Requests</th>
                <th>Success Rate</th>
                <th>Avg Time</th>
                <th>Last Used</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="accounts-table">
              <tr><td colspan="8"><div class="loading"><div class="spinner"></div>Loading...</div></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Gateway Page -->
    <div class="page" id="page-gateway">
      <div class="page-header">
        <h2>API Gateway - Quick Start</h2>
      </div>

      <!-- Endpoint Configuration -->
      <div class="panel">
        <div class="panel-header"><span class="panel-title">Endpoint Configuration</span></div>
        <div class="panel-body">
          <div class="gateway-box">
            <div class="label">Base URL (OpenAI Compatible)</div>
            <code id="gateway-url">http://localhost:9000/v1</code>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
            <div class="gateway-box">
              <div class="label">Chat Completions</div>
              <code>POST /v1/chat/completions</code>
            </div>
            <div class="gateway-box">
              <div class="label">Models List</div>
              <code>GET /v1/models</code>
            </div>
          </div>
          <div class="gateway-box" style="margin-top:12px;background:rgba(34,197,94,.08);border-color:var(--green)">
            <div class="label" style="color:var(--green)">Authentication</div>
            <code style="color:var(--text)">Authorization: Bearer any-key</code>
            <p style="font-size:12px;color:var(--text3);margin-top:8px">Gateway mode: Any Bearer token is accepted. The gateway automatically uses pool accounts.</p>
          </div>
        </div>
      </div>

      <!-- Available Models -->
      <div class="panel">
        <div class="panel-header"><span class="panel-title">Available Models</span></div>
        <div class="panel-body">
          <div style="display:flex;flex-wrap:wrap;gap:8px">
            <span class="badge badge-active">gpt-4o-mini</span>
            <span class="badge badge-active">gpt-4o</span>
            <span class="badge badge-active">gpt-4</span>
            <span class="badge badge-active">gpt-3.5-turbo</span>
            <span class="badge badge-active">claude-3-5-sonnet-20241022</span>
          </div>
          <p style="font-size:12px;color:var(--text3);margin-top:12px">Supports 100+ models including GPT-4o, Claude, Gemini, etc. Check APIPod documentation for full list.</p>
        </div>
      </div>

      <!-- Code Examples with Tabs -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">Quick Start Examples</span>
          <div class="btn-group">
            <button class="btn btn-sm btn-primary" id="tab-python" onclick="showCodeTab('python')">Python</button>
            <button class="btn btn-sm btn-ghost" id="tab-nodejs" onclick="showCodeTab('nodejs')">Node.js</button>
            <button class="btn btn-sm btn-ghost" id="tab-curl" onclick="showCodeTab('curl')">cURL</button>
          </div>
        </div>
        <div class="panel-body">
          <!-- Python -->
          <div id="code-python" class="code-tab">
<pre class="code-block"><span class="code-comment"># Install: pip install openai</span>
<span class="code-keyword">from</span> openai <span class="code-keyword">import</span> OpenAI

client = OpenAI(
    base_url=<span class="code-string">"<span id="example-url">http://localhost:9000/v1</span>"</span>,
    api_key=<span class="code-string">"any-key"</span>  <span class="code-comment"># Gateway uses pool accounts</span>
)

response = client.chat.completions.create(
    model=<span class="code-string">"gpt-4o-mini"</span>,
    messages=[
        {<span class="code-string">"role"</span>: <span class="code-string">"system"</span>, <span class="code-string">"content"</span>: <span class="code-string">"You are a helpful assistant."</span>},
        {<span class="code-string">"role"</span>: <span class="code-string">"user"</span>, <span class="code-string">"content"</span>: <span class="code-string">"Hello!"</span>}
    ]
)

<span class="code-keyword">print</span>(response.choices[0].message.content)</pre>
          </div>

          <!-- Node.js -->
          <div id="code-nodejs" class="code-tab" style="display:none">
<pre class="code-block"><span class="code-comment">// Install: npm install openai</span>
<span class="code-keyword">import</span> OpenAI <span class="code-keyword">from</span> <span class="code-string">'openai'</span>;

<span class="code-keyword">const</span> client = <span class="code-keyword">new</span> OpenAI({
    baseURL: <span class="code-string">'<span class="example-url-js">http://localhost:9000/v1</span>'</span>,
    apiKey: <span class="code-string">'any-key'</span>
});

<span class="code-keyword">async function</span> main() {
    <span class="code-keyword">const</span> response = <span class="code-keyword">await</span> client.chat.completions.create({
        model: <span class="code-string">'gpt-4o-mini'</span>,
        messages: [
            { role: <span class="code-string">'system'</span>, content: <span class="code-string">'You are a helpful assistant.'</span> },
            { role: <span class="code-string">'user'</span>, content: <span class="code-string">'Hello!'</span> }
        ]
    });

    console.log(response.choices[0].message.content);
}

main();</pre>
          </div>

          <!-- cURL -->
          <div id="code-curl" class="code-tab" style="display:none">
<pre class="code-block">curl <span class="code-string"><span class="example-url-curl">http://localhost:9000/v1</span>/chat/completions</span> \
  -H <span class="code-string">"Content-Type: application/json"</span> \
  -H <span class="code-string">"Authorization: Bearer any-key"</span> \
  -d <span class="code-string">'{
    "model": "gpt-4o-mini",
    "messages": [
        {"role": "system", "content": "You are a helpful assistant."},
        {"role": "user", "content": "Hello!"}
    ]
}'</span></pre>
          </div>
        </div>
      </div>

      <!-- Streaming Example -->
      <div class="panel">
        <div class="panel-header"><span class="panel-title">Streaming Response</span></div>
        <div class="panel-body">
<pre class="code-block"><span class="code-comment"># Enable streaming with stream=True</span>
stream = client.chat.completions.create(
    model=<span class="code-string">"gpt-4o-mini"</span>,
    messages=[{<span class="code-string">"role"</span>: <span class="code-string">"user"</span>, <span class="code-string">"content"</span>: <span class="code-string">"Tell me a story"</span>}],
    stream=<span class="code-keyword">True</span>
)

<span class="code-keyword">for</span> chunk <span class="code-keyword">in</span> stream:
    <span class="code-keyword">if</span> chunk.choices[0].delta.content:
        <span class="code-keyword">print</span>(chunk.choices[0].delta.content, end=<span class="code-string">""</span>)</pre>
        </div>
      </div>

      <!-- Error Handling -->
      <div class="panel">
        <div class="panel-header"><span class="panel-title">Error Handling</span></div>
        <div class="panel-body">
<pre class="code-block"><span class="code-keyword">from</span> openai <span class="code-keyword">import</span> OpenAI, APIError, RateLimitError

client = OpenAI(base_url=<span class="code-string">"<span class="example-url-err">http://localhost:9000/v1</span>"</span>, api_key=<span class="code-string">"any-key"</span>)

<span class="code-keyword">try</span>:
    response = client.chat.completions.create(
        model=<span class="code-string">"gpt-4o-mini"</span>,
        messages=[{<span class="code-string">"role"</span>: <span class="code-string">"user"</span>, <span class="code-string">"content"</span>: <span class="code-string">"Hello!"</span>}]
    )
<span class="code-keyword">except</span> RateLimitError <span class="code-keyword">as</span> e:
    <span class="code-keyword">print</span>(<span class="code-string">f"Rate limited. Retry after: {e.response.headers.get('Retry-After')}"</span>)
<span class="code-keyword">except</span> APIError <span class="code-keyword">as</span> e:
    <span class="code-keyword">print</span>(<span class="code-string">f"API error: {e.message}"</span>)</pre>
          <div style="margin-top:16px;padding:12px;background:var(--bg);border-radius:8px">
            <div style="font-size:12px;color:var(--text3);margin-bottom:8px">Common Error Codes</div>
            <table style="font-size:12px;width:100%">
              <tr><td style="padding:4px 8px;color:var(--yellow)">401</td><td style="padding:4px">Missing Authorization header</td></tr>
              <tr><td style="padding:4px 8px;color:var(--yellow)">429</td><td style="padding:4px">Rate limit exceeded</td></tr>
              <tr><td style="padding:4px 8px;color:var(--red)">500</td><td style="padding:4px">Internal server error</td></tr>
              <tr><td style="padding:4px 8px;color:var(--red)">502</td><td style="padding:4px">Upstream API error</td></tr>
              <tr><td style="padding:4px 8px;color:var(--red)">503</td><td style="padding:4px">No available account in pool</td></tr>
            </table>
          </div>
        </div>
      </div>

      <!-- Response Format -->
      <div class="panel">
        <div class="panel-header"><span class="panel-title">Response Format</span></div>
        <div class="panel-body">
<pre class="code-block" style="color:var(--text)">{
  <span class="code-string">"id"</span>: <span class="code-string">"chatcmpl-abc123"</span>,
  <span class="code-string">"object"</span>: <span class="code-string">"chat.completion"</span>,
  <span class="code-string">"created"</span>: <span class="code-number">1699876543</span>,
  <span class="code-string">"model"</span>: <span class="code-string">"gpt-4o-mini"</span>,
  <span class="code-string">"choices"</span>: [{
    <span class="code-string">"index"</span>: <span class="code-number">0</span>,
    <span class="code-string">"message"</span>: {
      <span class="code-string">"role"</span>: <span class="code-string">"assistant"</span>,
      <span class="code-string">"content"</span>: <span class="code-string">"Hello! How can I help you today?"</span>
    },
    <span class="code-string">"finish_reason"</span>: <span class="code-string">"stop"</span>
  }],
  <span class="code-string">"usage"</span>: {
    <span class="code-string">"prompt_tokens"</span>: <span class="code-number">20</span>,
    <span class="code-string">"completion_tokens"</span>: <span class="code-number">10</span>,
    <span class="code-string">"total_tokens"</span>: <span class="code-number">30</span>
  }
}</pre>
        </div>
      </div>

      <!-- Quick Test -->
      <div class="panel">
        <div class="panel-header"><span class="panel-title">Quick Test</span></div>
        <div class="panel-body">
          <div class="form-row">
            <div class="form-group">
              <label>Model</label>
              <select class="form-input" id="test-model">
                <option value="gpt-4o-mini">Loading models...</option>
              </select>
            </div>
            <div class="form-group">
              <label>Message</label>
              <input class="form-input" id="test-message" placeholder="Type a message to test..." value="Hello, who are you?">
            </div>
          </div>
          <button class="btn btn-primary" id="test-btn" onclick="testGateway()">Send Test Request</button>
          <button class="btn btn-ghost" style="margin-left:8px" onclick="testGatewayStream()">Test Streaming</button>
          <div id="test-result" style="margin-top:16px;display:none">
            <div class="gateway-box">
              <div class="label">Response <span id="test-time" style="float:right;color:var(--green)"></span></div>
              <div id="test-response" style="padding:12px;font-size:13px;line-height:1.6;white-space:pre-wrap"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- API Keys Page -->
    <div class="page" id="page-apikeys">
      <div class="page-header">
        <h2>API Keys Management</h2>
        <div class="btn-group">
          <button class="btn btn-ghost btn-sm" onclick="loadApiKeys()">Refresh</button>
          <button class="btn btn-primary btn-sm" onclick="showModal('add-key-modal')">Create New Key</button>
        </div>
      </div>

      <!-- Settings Panel -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">Security Settings</span>
        </div>
        <div class="panel-body">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
            <div class="gateway-box">
              <div class="label">Authentication Mode</div>
              <div style="margin-top:12px">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:8px">
                  <input type="radio" name="auth-mode" value="any" id="mode-any" onchange="updateKeySettings()">
                  <span style="font-size:13px">Allow Any Key (Compatibility Mode)</span>
                </label>
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                  <input type="radio" name="auth-mode" value="strict" id="mode-strict" onchange="updateKeySettings()">
                  <span style="font-size:13px">Strict Mode (Only Listed Keys)</span>
                </label>
              </div>
              <p style="font-size:11px;color:var(--text3);margin-top:8px">Compatibility mode accepts any Bearer token. Strict mode only accepts keys from the list below.</p>
            </div>
            <div class="gateway-box" style="background:rgba(59,130,246,.08);border-color:var(--blue)">
              <div class="label" style="color:var(--blue)">Current Status</div>
              <div style="margin-top:8px;font-size:24px;font-weight:700" id="key-status">-</div>
              <p style="font-size:12px;color:var(--text3);margin-top:4px" id="key-count">- keys configured</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Keys List -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">API Keys</span>
        </div>
        <div class="panel-body no-pad">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Key</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="keys-table">
              <tr><td colspan="4"><div class="loading"><div class="spinner"></div>Loading...</div></td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Usage Instructions -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">How to Use</span>
        </div>
        <div class="panel-body">
          <p style="font-size:13px;color:var(--text2);margin-bottom:12px">Use your API key in the Authorization header:</p>
          <div class="code-block">Authorization: Bearer sk-your-api-key-here</div>
          <p style="font-size:12px;color:var(--text3);margin-top:12px">In compatibility mode, any Bearer token is accepted. In strict mode, only keys from the list above will work.</p>
        </div>
      </div>
    </div>

    <!-- Logs Page -->
    <div class="page" id="page-logs">
      <div class="page-header">
        <h2>Request Logs</h2>
        <button class="btn btn-ghost btn-sm" onclick="loadLogs()">Refresh</button>
      </div>
      <div class="panel">
        <div class="panel-body no-pad" id="logs-container">
          <div class="loading"><div class="spinner"></div>Loading...</div>
        </div>
      </div>
    </div>

    <!-- Register Page -->
    <div class="page" id="page-register">
      <div class="page-header">
        <h2>Batch Register</h2>
      </div>
      <div class="panel">
        <div class="panel-header"><span class="panel-title">Register New Accounts</span></div>
        <div class="panel-body">
          <div class="form-row">
            <div class="form-group">
              <label>Count</label>
              <input class="form-input" id="reg-count" type="number" value="5" min="1" max="50">
            </div>
            <div class="form-group">
              <label>Email Suffix</label>
              <input class="form-input" id="reg-suffix" value="tmpmail.net">
            </div>
          </div>
          <button class="btn btn-primary" onclick="triggerRegister()">Start Registration</button>
          <div id="reg-result" style="margin-top:16px"></div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header"><span class="panel-title">Import from accounts.json</span></div>
        <div class="panel-body">
          <div class="form-group">
            <label>Paste accounts.json content</label>
            <textarea class="form-input" id="import-json" rows="8" placeholder='[{"username":"...","email":"...","password":"...","api_key":"sk-...","base_url":"https://api.apipod.ai/v1","success":true}]'></textarea>
          </div>
          <button class="btn btn-success" onclick="importFromJson()">Import Accounts</button>
        </div>
      </div>
    </div>

  </div><!-- /main -->
</div><!-- /app -->

<!-- Add API Key Modal -->
<div class="modal-overlay" id="add-key-modal">
  <div class="modal" style="width:400px">
    <div class="modal-header">
      <h3>Create New API Key</h3>
      <button class="modal-close" onclick="hideModal('add-key-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Key Name</label>
        <input class="form-input" id="new-key-name" placeholder="e.g., Production Key, Test Key">
      </div>
      <p style="font-size:12px;color:var(--text3)">A new API key will be generated automatically.</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="hideModal('add-key-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="createApiKey()">Create Key</button>
    </div>
  </div>
</div>

<!-- Show API Key Modal -->
<div class="modal-overlay" id="show-key-modal">
  <div class="modal" style="width:500px">
    <div class="modal-header">
      <h3>API Key Created</h3>
      <button class="modal-close" onclick="hideModal('show-key-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div style="background:rgba(34,197,94,.1);border:1px solid var(--green);border-radius:8px;padding:16px;margin-bottom:16px">
        <p style="font-size:12px;color:var(--green);margin-bottom:8px">Your new API key (copy it now, it won't be shown again):</p>
        <div style="display:flex;gap:8px">
          <input class="form-input" id="created-key" readonly style="font-family:monospace;font-size:12px">
          <button class="btn btn-success btn-sm" onclick="copyCreatedKey()">Copy</button>
        </div>
      </div>
      <p style="font-size:12px;color:var(--text3)">Store this key securely. For security reasons, the full key will be hidden in the list.</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="hideModal('show-key-modal')">Done</button>
    </div>
  </div>
</div>

<!-- Add Account Modal -->
<div class="modal-overlay" id="add-modal">
  <div class="modal">
    <div class="modal-header">
      <h3>Add Account</h3>
      <button class="modal-close" onclick="hideModal('add-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label>Username</label>
          <input class="form-input" id="add-username" placeholder="username">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input class="form-input" id="add-email" placeholder="user@example.com">
        </div>
      </div>
      <div class="form-group">
        <label>Password</label>
        <input class="form-input" id="add-password" type="password" placeholder="password">
      </div>
      <div class="form-group">
        <label>API Key</label>
        <input class="form-input" id="add-apikey" placeholder="sk-...">
      </div>
      <div class="form-group">
        <label>Base URL</label>
        <input class="form-input" id="add-baseurl" value="https://api.apipod.ai/v1">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="hideModal('add-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="addAccount()">Add</button>
    </div>
  </div>
</div>

<!-- Import Modal -->
<div class="modal-overlay" id="import-modal">
  <div class="modal">
    <div class="modal-header">
      <h3>Import Accounts</h3>
      <button class="modal-close" onclick="hideModal('import-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Select accounts.json file</label>
        <input type="file" id="import-file" accept=".json" class="form-input" style="padding:8px">
      </div>
      <p style="font-size:12px;color:var(--text3);margin-top:8px">Supports the JSON format generated by batch_register.py</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="hideModal('import-modal')">Cancel</button>
      <button class="btn btn-success" onclick="importFile()">Import</button>
    </div>
  </div>
</div>

<script>
const API = '';
let currentUser = null;

// ========== Auth Check ==========
async function checkAuth() {
  try {
    const res = await fetch('/api/auth/check');
    const data = await res.json();
    if (!data.authenticated) {
      window.location.href = '/login';
      return false;
    }
    currentUser = data;
    // Update user info display
    document.getElementById('user-info').style.display = 'block';
    document.getElementById('user-name').textContent = data.username;
    document.getElementById('user-role').textContent = data.role === 'admin' ? 'Administrator' : 'User';
    document.getElementById('user-avatar').textContent = data.username.charAt(0).toUpperCase();
    return true;
  } catch (e) {
    window.location.href = '/login';
    return false;
  }
}

async function logout() {
  try {
    await fetch('/api/auth/logout', { method: 'POST' });
  } catch (e) {}
  window.location.href = '/login';
}

// Check auth on page load
checkAuth().then(ok => {
  if (ok) refreshDashboard();
});

// ========== Navigation ==========
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => {
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    item.classList.add('active');
    const page = item.dataset.page;
    document.getElementById('page-' + page).classList.add('active');
    if (page === 'dashboard') refreshDashboard();
    else if (page === 'accounts') loadAccounts();
    else if (page === 'logs') loadLogs();
    else if (page === 'apikeys') loadApiKeys();
  });
});

// ========== Toast ==========
function toast(msg, type = 'success') {
  const el = document.createElement('div');
  el.className = 'toast toast-' + type;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// ========== Modal ==========
function showModal(id) { document.getElementById(id).classList.add('show'); }
function hideModal(id) { document.getElementById(id).classList.remove('show'); }

// ========== API Calls ==========
async function api(path, options = {}) {
  const res = await fetch(API + path, {
    headers: { 'Content-Type': 'application/json' },
    ...options
  });
  return res.json();
}

// ========== Dashboard ==========
async function refreshDashboard() {
  try {
    const data = await api('/api/admin/dashboard');
    document.getElementById('stat-total').textContent = data.total || 0;
    document.getElementById('stat-active').textContent = data.active || 0;
    document.getElementById('stat-error').textContent = (data.error || 0) + ' / ' + (data.cooling || 0);
    document.getElementById('stat-requests').textContent = data.total_requests || 0;
    document.getElementById('stat-success-rate').textContent = (data.success_rate || 0) + '%';
    document.getElementById('stat-avg-time').textContent = (data.avg_response_time || 0) + 's';

    // Recent logs
    const logs = data.recent_logs || [];
    renderLogs('recent-logs', logs);
  } catch (e) {
    document.getElementById('recent-logs').innerHTML = '<div class="empty"><p>Failed to load dashboard data</p></div>';
  }
}

function renderLogs(containerId, logs) {
  const c = document.getElementById(containerId);
  if (!logs.length) {
    c.innerHTML = '<div class="empty"><p>No request logs yet</p></div>';
    return;
  }
  c.innerHTML = logs.map(l => {
    const t = new Date(l.time);
    const timeStr = t.toLocaleTimeString('zh-CN', {hour12:false}).slice(0,8);
    const statusBadge = l.success
      ? '<span class="badge badge-active">OK</span>'
      : '<span class="badge badge-error">ERR</span>';
    return `<div class="log-item">
      <span class="log-time">${timeStr}</span>
      <span class="log-method">${l.method || '-'}</span>
      <span class="log-account">${l.account || '-'}</span>
      <span class="log-status">${statusBadge}</span>
      <span class="log-time-val">${l.response_time || 0}s</span>
    </div>`;
  }).join('');
}

// ========== Accounts ==========
async function loadAccounts() {
  try {
    const data = await api('/api/admin/accounts');
    const tbody = document.getElementById('accounts-table');
    const accounts = data.accounts || [];

    if (!accounts.length) {
      tbody.innerHTML = '<tr><td colspan="8"><div class="empty"><p>No accounts. Add or import accounts to get started.</p></div></td></tr>';
      return;
    }

    tbody.innerHTML = accounts.map(a => {
      const lastUsed = a.last_used ? new Date(a.last_used).toLocaleString('zh-CN', {hour12:false}) : '-';
      return `<tr>
        <td class="td-email">${a.email}</td>
        <td>${a.username || '-'}</td>
        <td><span class="badge badge-${a.status}">${a.status}</span>${a.is_cooling ? ' <span style="font-size:11px;color:var(--yellow)">(cooling)</span>' : ''}</td>
        <td>${a.request_count}</td>
        <td>${a.success_rate}%</td>
        <td>${a.avg_response_time}s</td>
        <td style="font-size:12px;color:var(--text3)">${lastUsed}</td>
        <td>
          <div class="btn-group">
            <button class="btn btn-ghost btn-sm" onclick="toggleAccount('${a.email}')">${a.status === 'active' ? 'Disable' : 'Enable'}</button>
            <button class="btn btn-ghost btn-sm" onclick="healthCheck('${a.email}')">Check</button>
            <button class="btn btn-danger btn-sm" onclick="deleteAccount('${a.email}')">Del</button>
          </div>
        </td>
      </tr>`;
    }).join('');
  } catch (e) {
    document.getElementById('accounts-table').innerHTML = '<tr><td colspan="8"><div class="empty"><p>Failed to load accounts</p></div></td></tr>';
  }
}

async function toggleAccount(email) {
  const data = await api(`/api/admin/accounts/${encodeURIComponent(email)}/toggle`, { method: 'POST' });
  toast(data.success ? `Status: ${data.status}` : 'Failed', data.success ? 'success' : 'error');
  loadAccounts();
}

async function healthCheck(email) {
  toast('Checking...');
  const data = await api(`/api/admin/accounts/${encodeURIComponent(email)}/health`, { method: 'POST' });
  toast(data.success ? 'Healthy' : 'Failed', data.success ? 'success' : 'error');
  loadAccounts();
}

async function deleteAccount(email) {
  if (!confirm(`Delete account ${email}?`)) return;
  const data = await api(`/api/admin/accounts/${encodeURIComponent(email)}`, { method: 'DELETE' });
  toast(data.success ? 'Deleted' : 'Failed', data.success ? 'success' : 'error');
  loadAccounts();
}

async function addAccount() {
  const body = {
    username: document.getElementById('add-username').value,
    email: document.getElementById('add-email').value,
    password: document.getElementById('add-password').value,
    api_key: document.getElementById('add-apikey').value,
    base_url: document.getElementById('add-baseurl').value
  };
  if (!body.email || !body.api_key) { toast('Email and API Key required', 'error'); return; }
  const data = await api('/api/admin/accounts', { method: 'POST', body: JSON.stringify(body) });
  toast(data.success ? 'Added' : (data.error || 'Failed'), data.success ? 'success' : 'error');
  hideModal('add-modal');
  loadAccounts();
}

async function healthCheckAll() {
  toast('Health checking all accounts...');
  const data = await api('/api/admin/health-check', { method: 'POST' });
  toast(`Done: ${data.success || 0} ok, ${data.failed || 0} failed`);
  refreshDashboard();
}

// ========== Import ==========
async function importFile() {
  const fileInput = document.getElementById('import-file');
  if (!fileInput.files.length) { toast('Select a file', 'error'); return; }

  const text = await fileInput.files[0].text();
  try {
    const accounts = JSON.parse(text);
    const arr = Array.isArray(accounts) ? accounts : (accounts.accounts || []);
    const data = await api('/api/admin/import', {
      method: 'POST',
      body: JSON.stringify({ accounts: arr })
    });
    toast(`Imported ${data.imported || 0} accounts`);
    hideModal('import-modal');
    loadAccounts();
  } catch (e) {
    toast('Invalid JSON file', 'error');
  }
}

async function importFromJson() {
  const text = document.getElementById('import-json').value.trim();
  if (!text) { toast('Paste JSON content', 'error'); return; }
  try {
    const accounts = JSON.parse(text);
    const arr = Array.isArray(accounts) ? accounts : (accounts.accounts || []);
    const data = await api('/api/admin/import', {
      method: 'POST',
      body: JSON.stringify({ accounts: arr })
    });
    toast(`Imported ${data.imported || 0} accounts`);
    document.getElementById('import-json').value = '';
    loadAccounts();
  } catch (e) {
    toast('Invalid JSON', 'error');
  }
}

// ========== Logs ==========
async function loadLogs() {
  try {
    const data = await api('/api/admin/logs?limit=100');
    renderLogs('logs-container', data.logs || []);
  } catch (e) {
    document.getElementById('logs-container').innerHTML = '<div class="empty"><p>Failed to load logs</p></div>';
  }
}

// ========== Gateway Test ==========
function showCodeTab(tab) {
  ['python', 'nodejs', 'curl'].forEach(t => {
    document.getElementById('code-' + t).style.display = t === tab ? 'block' : 'none';
    document.getElementById('tab-' + t).className = 'btn btn-sm ' + (t === tab ? 'btn-primary' : 'btn-ghost');
  });
}

async function testGateway() {
  const model = document.getElementById('test-model').value;
  const message = document.getElementById('test-message').value;
  if (!message) return;

  const btn = document.getElementById('test-btn');
  btn.disabled = true;
  btn.textContent = 'Sending...';
  document.getElementById('test-result').style.display = 'none';
  const startTime = Date.now();

  try {
    const res = await fetch(API + '/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer gateway-key'
      },
      body: JSON.stringify({ model, messages: [{ role: 'user', content: message }] })
    });
    const data = await res.json();
    const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);

    document.getElementById('test-result').style.display = 'block';
    document.getElementById('test-time').textContent = elapsed + 's';
    if (data.error) {
      document.getElementById('test-response').textContent = 'Error: ' + (data.error.message || JSON.stringify(data.error));
    } else {
      const content = data.choices?.[0]?.message?.content || JSON.stringify(data, null, 2);
      document.getElementById('test-response').textContent = content;
    }
  } catch (e) {
    document.getElementById('test-result').style.display = 'block';
    document.getElementById('test-time').textContent = '';
    document.getElementById('test-response').textContent = 'Request failed: ' + e.message;
  }

  btn.disabled = false;
  btn.textContent = 'Send Test Request';
}

async function testGatewayStream() {
  const model = document.getElementById('test-model').value;
  const message = document.getElementById('test-message').value;
  if (!message) return;

  const btn = document.getElementById('test-btn');
  btn.disabled = true;
  document.getElementById('test-result').style.display = 'block';
  document.getElementById('test-response').textContent = '';
  document.getElementById('test-time').textContent = 'streaming...';
  const startTime = Date.now();

  try {
    const res = await fetch(API + '/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer gateway-key'
      },
      body: JSON.stringify({ model, messages: [{ role: 'user', content: message }], stream: true })
    });

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let content = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      const chunk = decoder.decode(value);
      const lines = chunk.split('\n');

      for (const line of lines) {
        if (line.startsWith('data: ') && line !== 'data: [DONE]') {
          try {
            const data = JSON.parse(line.slice(6));
            const delta = data.choices?.[0]?.delta?.content || '';
            content += delta;
            document.getElementById('test-response').textContent = content;
          } catch (e) {}
        }
      }
    }

    const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
    document.getElementById('test-time').textContent = elapsed + 's';
  } catch (e) {
    document.getElementById('test-response').textContent = 'Stream failed: ' + e.message;
    document.getElementById('test-time').textContent = '';
  }

  btn.disabled = false;
}

// ========== Register ==========
async function triggerRegister() {
  const count = parseInt(document.getElementById('reg-count').value) || 5;
  const suffix = document.getElementById('reg-suffix').value || 'tmpmail.net';
  const data = await api('/api/admin/register', {
    method: 'POST',
    body: JSON.stringify({ count, suffix })
  });
  document.getElementById('reg-result').innerHTML = `
    <div class="gateway-box">
      <div class="label">CLI Command</div>
      <code>python batch_register.py --count ${count} --suffix ${suffix}</code>
      <p style="font-size:12px;color:var(--text3);margin-top:8px">Run this command in terminal, then import accounts.json here.</p>
    </div>`;
}

// ========== Load Models ==========
async function loadModels() {
  try {
    const res = await fetch(API + '/v1/models', {
      headers: { 'Authorization': 'Bearer gateway-key' }
    });
    const data = await res.json();
    const select = document.getElementById('test-model');
    const models = data.data || [];

    if (models.length === 0) {
      select.innerHTML = '<option value="gpt-4o-mini">gpt-4o-mini</option>';
      return;
    }

    // Sort: gpt-4o-mini first, then alphabetically
    models.sort((a, b) => {
      if (a.id === 'gpt-4o-mini') return -1;
      if (b.id === 'gpt-4o-mini') return 1;
      return a.id.localeCompare(b.id);
    });

    select.innerHTML = models.map(m =>
      `<option value="${m.id}"${m.id === 'gpt-4o-mini' ? ' selected' : ''}>${m.id}</option>`
    ).join('');
  } catch (e) {
    document.getElementById('test-model').innerHTML = '<option value="gpt-4o-mini">gpt-4o-mini</option>';
  }
}

// ========== Gateway URL ==========
function updateGatewayUrl() {
  const url = window.location.origin + '/v1';
  document.getElementById('gateway-url').textContent = url;
  document.getElementById('example-url').textContent = url;
  document.querySelectorAll('.example-url-js').forEach(el => el.textContent = url);
  document.querySelectorAll('.example-url-curl').forEach(el => el.textContent = url);
  document.querySelectorAll('.example-url-err').forEach(el => el.textContent = url);
}

// ========== API Keys ==========
async function loadApiKeys() {
  try {
    const data = await api('/api/admin/keys');
    const keys = data.keys || [];
    const settings = data.settings || {};

    // Update settings UI
    document.getElementById('mode-any').checked = settings.allow_any_key;
    document.getElementById('mode-strict').checked = !settings.allow_any_key;
    document.getElementById('key-status').textContent = settings.allow_any_key ? 'Open' : 'Protected';
    document.getElementById('key-status').style.color = settings.allow_any_key ? 'var(--yellow)' : 'var(--green)';
    document.getElementById('key-count').textContent = `${keys.length} key(s) configured`;

    // Update keys table
    const tbody = document.getElementById('keys-table');
    if (keys.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4"><div class="empty"><p>No API keys configured</p></div></td></tr>';
      return;
    }

    tbody.innerHTML = keys.map(k => `
      <tr>
        <td><strong>${k.name}</strong></td>
        <td>
          <code style="font-size:12px;color:var(--cyan);background:var(--bg);padding:4px 8px;border-radius:4px">${k.key}</code>
          <button class="btn btn-ghost btn-sm" onclick="copyKey('${k.full_key}')" title="Copy full key" style="margin-left:8px;padding:4px 8px">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
          </button>
        </td>
        <td style="color:var(--text3);font-size:12px">${new Date(k.created_at).toLocaleString()}</td>
        <td>
          <button class="btn btn-danger btn-sm" onclick="deleteApiKey('${k.full_key}')">Delete</button>
        </td>
      </tr>
    `).join('');
  } catch (e) {
    document.getElementById('keys-table').innerHTML = '<tr><td colspan="4"><div class="empty"><p>Failed to load API keys</p></div></td></tr>';
  }
}

async function createApiKey() {
  const name = document.getElementById('new-key-name').value.trim() || 'New Key';
  try {
    const data = await api('/api/admin/keys', {
      method: 'POST',
      body: JSON.stringify({ name })
    });
    if (data.success && data.key) {
      hideModal('add-key-modal');
      document.getElementById('new-key-name').value = '';
      document.getElementById('created-key').value = data.key.key;
      showModal('show-key-modal');
      loadApiKeys();
      toast('API key created successfully');
    } else {
      toast(data.error || 'Failed to create key', 'error');
    }
  } catch (e) {
    toast('Failed to create key', 'error');
  }
}

async function deleteApiKey(key) {
  if (!confirm('Are you sure you want to delete this API key? This action cannot be undone.')) return;
  try {
    const data = await api('/api/admin/keys', {
      method: 'DELETE',
      body: JSON.stringify({ key })
    });
    if (data.success) {
      toast('API key deleted');
      loadApiKeys();
    } else {
      toast(data.error || 'Failed to delete key', 'error');
    }
  } catch (e) {
    toast('Failed to delete key', 'error');
  }
}

async function updateKeySettings() {
  const allowAny = document.getElementById('mode-any').checked;
  try {
    await api('/api/admin/keys/settings', {
      method: 'POST',
      body: JSON.stringify({ allow_any_key: allowAny })
    });
    loadApiKeys();
    toast('Settings updated');
  } catch (e) {
    toast('Failed to update settings', 'error');
  }
}

function copyKey(key) {
  navigator.clipboard.writeText(key).then(() => {
    toast('API key copied to clipboard');
  }).catch(() => {
    toast('Failed to copy', 'error');
  });
}

function copyCreatedKey() {
  const key = document.getElementById('created-key').value;
  navigator.clipboard.writeText(key).then(() => {
    toast('API key copied to clipboard');
  }).catch(() => {
    toast('Failed to copy', 'error');
  });
}

// ========== Init ==========
updateGatewayUrl();
refreshDashboard();
loadModels();

// Auto-refresh every 30s
setInterval(() => {
  const activePage = document.querySelector('.page.active');
  if (activePage?.id === 'page-dashboard') refreshDashboard();
}, 30000);
</script>
</body>
</html>
